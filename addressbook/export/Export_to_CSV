<?php
// This file defines a set of functions and an associative array.
// The key of the array corresponds to a header in the source
// export file and the value of the array item will be used in
// the creation of the output file.
//
// An exported Outlook file looks like this:
//
// Title<tab>First Name<tab>Middle Name<tab>Last Name<tab>...
// <tab>Patrick<tab><tab>Walsh<tab>...
//
// Where the first line explains each optional field.  This is what
// will be looked up in the key.
//
// The array need not be in any order and any fields not defined will
// not be transferred.  If the val='+', the value will be appended to
// the previous field and any text after the '+' will be appended 
// before the value.  For example, the following would add a comma and
// a space between LastName and FirstName and store it in FullName:
//
//	array("LastName" => "FullName","FirstName" => "+, ");
//
// Also start with a '#' symbol and a comma separated list will be
// turned into a number of the same entries.

	class export_conv
	{
		var $currentrecord = array(); //used for buffering to allow uid lines to go first
		var $id;
		var $type = 'csv';

		var $export = array(
			"title"               => "Title",
			"n_given"             => "First Name",
			"n_middle"            => "Middle Name",
			"n_family"            => "Last Name",
			"n_suffix"            => "Suffix",
			"org_name"            => "Company",
			"org_unit"            => "Department",
			"adr_one_street"      => "Business Street",
			"address2"            => "Business Street 2",
			"address3"            => "Business Street 3",
			"adr_one_locality"    => "Business City",
			"adr_one_region"      => "Business State",
			"adr_one_postalcode"  => "Business Postal Code",
			"adr_one_countryname" => "Business Country",
			"adr_two_street"      => "Home Street",
			"adr_two_locality"    => "Home City",
			"adr_two_region"      => "Home State",
			"adr_two_postalcode"  => "Home Postal Code",
			"adr_two_countryname" => "Home Country",
			"tel_fax"             => "Business Fax",
			"tel_work"            => "Business Phone",
			"tel_msg"             => "Assistant's Phone",
			"tel_car"             => "Car Phone",
			"tel_isdn"            => "ISDN",
			"tel_home"            => "Home Phone",
			"tel_cell"            => "Mobile Phone",
			"tel_pager"           => "Pager",
			"ophone"              => "Business Phone 2",
			"bday"                => "Birthday",
			"email"               => "E-mail Address",
			"email_home"          => "E-mail Address 2",
			"url"                 => "Web Page",
			"note"                => "Notes"
		);

		function export_start_file($buffer,$j="",$k="") {
			return $buffer;
		}

		function export_end_file($buffer) {
			global $phpgw,$phpgw_info;

			$contacts = CreateObject("phpgwapi.contacts");
			echo '<br>'; 
			for ($i=1;$i<=count($buffer);$i++) {
				while ( list($name,$value) = @each($buffer[$i]) ) {
					//echo '<br>'.$i.': '.$name.' => '.$value;
					$entry[$i][$name] = $value;
				}
				//echo '<br>';
				$contacts->add($phpgw_info["user"]["account_id"],$entry[$i]);
			}
			$num = $i - 1;
			return "Successfully exported $num records from your addressbook.";
		}

		function export_start_record($buffer) {
			$top=array();
			++$this->id;
			$this->currentrecord = $top;
			return $buffer;
		}

		function export_end_record($buffer,$private="private") {
			global $phpgw_info;
			$buffer[$this->id]="";
			while ( list($name, $value) = each($this->currentrecord)) {
				$buffer[$this->id][$name] = $value;
				//echo '<br>'.$name.' => '.$value;
			}
			return $buffer;
		}

		function export_new_attrib($buffer,$name,$value) {
			$value = str_replace("\n","<BR>",$value);
			$value = str_replace("\r","",$value);
			$this->currentrecord += array($name => $value);

			return $buffer;
		}
	}
?>
